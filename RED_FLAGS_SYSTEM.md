# Red Flags System - Firebase Integration

## Overview

The red flags system has been refactored from a static array to a scalable Firebase-based solution. This provides better organization, dynamic content management, and improved performance through caching.

## Architecture

### Firebase Collection Structure

**Collection: `red_flags`**

Each document contains:
```typescript
interface RedFlag {
  id: string;                    // Auto-generated by Firestore
  text: string;                  // The red flag description
  category: 'culture' | 'leadership' | 'role' | 'process' | 'communication' | 'compensation' | 'stability' | 'environment';
  severity: 'light' | 'medium';
  explanation?: string;          // Optional explanation
  tags?: string[];              // Searchable tags
  createdAt: Timestamp;         // Firestore timestamp
  updatedAt: Timestamp;         // Firestore timestamp
  isActive: boolean;            // Soft delete flag
  usageCount: number;           // Track how often this flag is used
  priority: number;             // For ordering/curation (higher = more important)
}
```

### Key Improvements

1. **Scalable**: No longer limited by static array size
2. **Organized**: Better severity classification (light/medium)
3. **Trackable**: Usage analytics and priority-based ordering
4. **Cached**: 5-minute cache for performance
5. **Fallback**: Graceful degradation when Firebase is unavailable
6. **Tagged**: Searchable tags for better organization

## Setup Instructions

### 1. Firebase Configuration

Ensure your Firebase configuration is set up in `.env.local`:
```env
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
```

### 2. Firebase Setup (Optional)

The scripts will work with your existing Firebase configuration. For admin operations, you can optionally set up a service account:

1. Go to Firebase Console → Project Settings → Service Accounts
2. Generate new private key
3. Save the JSON file as `firebase-service-account.json` in the scripts folder, OR
4. Set environment variable: `FIREBASE_SERVICE_ACCOUNT` with the JSON content

### 3. Populate Initial Data

Run the population script:

**Windows:**
```cmd
scripts\run_populate_red_flags.bat
```

**Linux/Mac:**
```bash
chmod +x scripts/run_populate_red_flags.sh
./scripts/run_populate_red_flags.sh
```

This will create 5 sample red flags with different severities and categories.

## Usage

### Frontend Integration

The new system is backward compatible. Update your imports:

```typescript
// Old way (still works)
import { getBalancedRedFlags, redFlags } from '@/lib/redFlags';

// New way (recommended)
import { redFlagsService } from '@/lib/redFlags';

// Get curated flags for the 3x3 grid
const flags = await redFlagsService.getCuratedFlags(9);

// Get flags by severity
const mediumFlags = await redFlagsService.getRedFlagsBySeverity('medium');

// Get flags by category
const cultureFlags = await redFlagsService.getRedFlagsByCategory('culture');
```

### Service Methods

```typescript
// Get all active red flags
const allFlags = await redFlagsService.getAllRedFlags();

// Get curated selection (strategic mix of severities)
const curated = await redFlagsService.getCuratedFlags(9);

// Get flags by severity
const lightFlags = await redFlagsService.getRedFlagsBySeverity('light');
const mediumFlags = await redFlagsService.getRedFlagsBySeverity('medium');

// Get flags by category
const processFlags = await redFlagsService.getRedFlagsByCategory('process');

// Increment usage count (called when user selects a flag)
await redFlagsService.incrementUsageCount(flagId);

// Create new red flag (admin function)
const newFlagId = await redFlagsService.createRedFlag({
  text: "New red flag description",
  category: "culture",
  severity: "medium",
  explanation: "Optional explanation",
  tags: ["tag1", "tag2"],
  isActive: true,
  priority: 5
});
```

## Curation Strategy

The `getCuratedFlags()` method implements a strategic selection:

- **9-flag grid**: 3 medium, 6 light severity flags
- **Flexible count**: Proportional selection based on count
- **Randomized**: Shuffled within severity groups
- **Priority-based**: Higher priority flags appear more often

## Performance Features

1. **Caching**: 5-minute cache for `getAllRedFlags()`
2. **Lazy Loading**: Flags loaded only when needed
3. **Fallback Data**: Works offline with minimal sample data
4. **Error Handling**: Graceful degradation on Firebase errors

## Migration from Old System

The old static `redFlags` array is still exported for backward compatibility, but it's now empty. The new system:

1. ✅ Maintains the same interface
2. ✅ Adds new functionality
3. ✅ Improves performance
4. ✅ Enables dynamic content management

## Admin Operations

### Adding New Red Flags

1. **Via Firebase Console**: Direct document creation
2. **Via Script**: Use `redFlagsService.createRedFlag()`
3. **Via Admin Interface**: Future feature

### Managing Existing Flags

- **Deactivate**: Set `isActive: false`
- **Update Priority**: Modify `priority` field
- **Track Usage**: Monitor `usageCount` field
- **Add Tags**: Update `tags` array

## Best Practices

1. **Severity Classification**:
   - **Light**: Subtle warning signs, gut feelings
   - **Medium**: Noticeable issues, concerning patterns

2. **Priority Setting**:
   - **10-8**: Most important/common flags
   - **7-5**: Important but less common
   - **4-1**: Niche or specific flags

3. **Tagging**:
   - Use descriptive, searchable tags
   - Include related concepts
   - Keep tags consistent

## Troubleshooting

### Common Issues

1. **Firebase not initialized**:
   - Check environment variables
   - Verify Firebase configuration

2. **No flags loading**:
   - Check if collection exists
   - Verify `isActive: true` flags exist
   - Check network connectivity

3. **Performance issues**:
   - Clear cache by restarting app
   - Check Firebase quotas
   - Monitor network requests

### Debug Mode

Enable debug logging:
```typescript
// In browser console
localStorage.setItem('debug_red_flags', 'true');
```

## Future Enhancements

1. **Admin Interface**: Web-based flag management
2. **Analytics Dashboard**: Usage statistics and insights
3. **A/B Testing**: Different flag combinations
4. **User Feedback**: Flag rating and suggestions
5. **Machine Learning**: Smart flag recommendations

## Support

For issues or questions about the red flags system:
1. Check this documentation
2. Review Firebase console logs
3. Test with fallback data
4. Verify environment setup 